!function(){function e(e,i){e||t(i)}function t(e){throw Error(e=e??"Assert failed")}class i{static #e=(()=>{this.TOUCH_DEADZONE=5})();static #t=(()=>{this.TOUCH_DEADZONE_SQ=25})();get pxPerRem(){return this.pxPerRem_}constructor(e){this.touchResponders_=[],this.pxPerRem_=0,this.onResize_=()=>{this.refreshUnits_()},this.onWindowMouseMove_=e=>{if(1!==e.buttons)for(let t of this.touchResponders_)t.onTouchUp(-1,!0,e.timeStamp);else for(let t of this.touchResponders_)t.onTouchMoved(-1,e.pageX,e.pageY,e.timeStamp)},this.onWindowMouseUp_=e=>{if(0===e.button)for(let t of this.touchResponders_)t.onTouchUp(-1,!1,e.timeStamp)},this.onWindowTouchMove_=e=>{for(let t=0;t<e.changedTouches.length;++t){let i=e.changedTouches.item(t);if(i)for(let t of this.touchResponders_)t.onTouchMoved(i.identifier,i.pageX,i.pageY,e.timeStamp)}},this.onWindowTouchEnd_=e=>{for(let t=0;t<e.changedTouches.length;++t){let i=e.changedTouches.item(t);if(i)for(let t of this.touchResponders_)t.onTouchUp(i.identifier,!1,e.timeStamp)}},this.onWindowTouchCancel_=e=>{for(let t=0;t<e.changedTouches.length;++t){let i=e.changedTouches.item(t);if(i)for(let t of this.touchResponders_)t.onTouchUp(i.identifier,!0,e.timeStamp)}},this.element_=e,window.addEventListener("resize",this.onResize_),window.addEventListener("mousemove",this.onWindowMouseMove_),window.addEventListener("mouseup",this.onWindowMouseUp_),window.addEventListener("touchmove",this.onWindowTouchMove_),window.addEventListener("touchend",this.onWindowTouchEnd_),window.addEventListener("touchcancel",this.onWindowTouchCancel_),this.refreshUnits_()}refreshUnits_(){let e=getComputedStyle(this.element_);this.pxPerRem_=1/parseFloat(e.fontSize)}addTouchResponder(t){let i=this.touchResponders_.indexOf(t);e(i<0),this.touchResponders_.push(t)}removeTouchResponder(t){let i=this.touchResponders_.indexOf(t);e(i>=0),this.touchResponders_.splice(i,1)}}function s(e,i){let s=document.getElementById(i);s instanceof HTMLTemplateElement||t();let r=s.content.firstElementChild;r instanceof HTMLElement||t();let a=document.importNode(r,!0);return a instanceof HTMLElement||t(),e.appendChild(a)}class r{constructor(e){this.context=new i(e),this.element=s(e,"rootViewTemplate")}dispose(){this.element.remove()}}(h=c||(c={}))[h.None=0]="None",h[h.Black=1]="Black",h[h.Red=2]="Red",(l=_||(_={}))[l.None=0]="None",l[l.Ace=1]="Ace",l[l.Two=2]="Two",l[l.Three=3]="Three",l[l.Four=4]="Four",l[l.Five=5]="Five",l[l.Six=6]="Six",l[l.Seven=7]="Seven",l[l.Eight=8]="Eight",l[l.Nine=9]="Nine",l[l.Ten=10]="Ten",l[l.Eleven=11]="Eleven",l[l.Twelve=12]="Twelve",l[l.Thirteen=13]="Thirteen",l[l.Jack=100]="Jack",l[l.Queen=101]="Queen",l[l.King=102]="King",(d=p||(p={}))[d.None=0]="None",d[d.Spades=1]="Spades",d[d.Hearts=2]="Hearts",d[d.Diamonds=3]="Diamonds",d[d.Clubs=4]="Clubs";let a=[[p.Spades,c.Black],[p.Hearts,c.Red],[p.Diamonds,c.Red],[p.Clubs,c.Black]],o=[_.Ace,_.Two,_.Three,_.Four,_.Five,_.Six,_.Seven,_.Eight,_.Nine,_.Ten,_.Jack,_.Queen,_.King];function n(e){let t=[];for(let[i,s]of a)for(let r of o){let a=e.createCard(i,s,r);t.push(a)}return t}(u=f||(f={}))[u.None=0]="None",u[u.Quick=1]="Quick",u[u.OneByOne=2]="OneByOne",u[u.Settle=3]="Settle";var h,l,d,u,c,_,p,f,g=function(e){return 214013*e+2531011&4294967295},w=function(e){return(-2147483649&e)>>16};!function(){function e(e){this.seed=e}e.prototype.clone=function(){return new e(this.seed)},e.prototype.next=function(){var t=new e(this.seed);return[t.unsafeNext(),t]},e.prototype.unsafeNext=function(){var e=g(this.seed),t=w(e),i=g(e),s=w(i);return this.seed=g(i),0|w(this.seed)+(s+(t<<15)<<15)}}(),function(){function e(e,t){this.states=e,this.index=t}e.twist=function(t){for(var i=t.slice(),s=0;s!==e.N-e.M;++s){var r=(i[s]&e.MASK_UPPER)+(i[s+1]&e.MASK_LOWER);i[s]=i[s+e.M]^r>>>1^-(1&r)&e.A}for(var s=e.N-e.M;s!==e.N-1;++s){var a=(i[s]&e.MASK_UPPER)+(i[s+1]&e.MASK_LOWER);i[s]=i[s+e.M-e.N]^a>>>1^-(1&a)&e.A}var o=(i[e.N-1]&e.MASK_UPPER)+(i[0]&e.MASK_LOWER);return i[e.N-1]=i[e.M-1]^o>>>1^-(1&o)&e.A,i},e.seeded=function(t){var i=Array(e.N);i[0]=t;for(var s=1;s!==e.N;++s){var r=i[s-1]^i[s-1]>>>30;i[s]=Math.imul(e.F,r)+s|0}return i},e.from=function(t){return new e(e.twist(e.seeded(t)),0)},e.prototype.clone=function(){return new e(this.states,this.index)},e.prototype.next=function(){var t=new e(this.states,this.index);return[t.unsafeNext(),t]},e.prototype.unsafeNext=function(){var t=this.states[this.index];return t^=this.states[this.index]>>>e.U,t^=t<<e.S&e.B,t^=t<<e.T&e.C,t^=t>>>e.L,++this.index>=e.N&&(this.states=e.twist(this.states),this.index=0),t},e.N=624,e.M=397,e.R=31,e.A=2567483615,e.F=1812433253,e.U=11,e.S=7,e.B=2636928640,e.T=15,e.C=4022730752,e.L=18,e.MASK_LOWER=Math.pow(2,e.R)-1,e.MASK_UPPER=Math.pow(2,e.R)}(),function(){function e(e,t,i,s){this.s01=e,this.s00=t,this.s11=i,this.s10=s}e.prototype.clone=function(){return new e(this.s01,this.s00,this.s11,this.s10)},e.prototype.next=function(){var t=new e(this.s01,this.s00,this.s11,this.s10);return[t.unsafeNext(),t]},e.prototype.unsafeNext=function(){var e=this.s00^this.s00<<23,t=this.s01^(this.s01<<23|this.s00>>>9),i=e^this.s10^(e>>>18|t<<14)^(this.s10>>>5|this.s11<<27),s=t^this.s11^t>>>18^this.s11>>>5,r=this.s00+this.s10|0;return this.s01=this.s11,this.s00=this.s10,this.s11=s,this.s10=i,r},e.prototype.jump=function(){var t=new e(this.s01,this.s00,this.s11,this.s10);return t.unsafeJump(),t},e.prototype.unsafeJump=function(){for(var e=0,t=0,i=0,s=0,r=[1667051007,2321340297,1548169110,304075285],a=0;4!==a;++a)for(var o=1;o;o<<=1)r[a]&o&&(e^=this.s01,t^=this.s00,i^=this.s11,s^=this.s10),this.unsafeNext();this.s01=e,this.s00=t,this.s11=i,this.s10=s}}(),function(){function e(e,t,i,s){this.s01=e,this.s00=t,this.s11=i,this.s10=s}e.prototype.clone=function(){return new e(this.s01,this.s00,this.s11,this.s10)},e.prototype.next=function(){var t=new e(this.s01,this.s00,this.s11,this.s10);return[t.unsafeNext(),t]},e.prototype.unsafeNext=function(){var e=this.s00+this.s10|0,t=this.s10^this.s00,i=this.s11^this.s01,s=this.s00,r=this.s01;return this.s00=s<<24^r>>>8^t^t<<16,this.s01=r<<24^s>>>8^i^(i<<16|t>>>16),this.s10=i<<5^t>>>27,this.s11=t<<5^i>>>27,e},e.prototype.jump=function(){var t=new e(this.s01,this.s00,this.s11,this.s10);return t.unsafeJump(),t},e.prototype.unsafeJump=function(){for(var e=0,t=0,i=0,s=0,r=[3639956645,3750757012,1261568508,386426335],a=0;4!==a;++a)for(var o=1;o;o<<=1)r[a]&o&&(e^=this.s01,t^=this.s00,i^=this.s11,s^=this.s10),this.unsafeNext();this.s01=e,this.s00=t,this.s11=i,this.s10=s}}();var m=$7c23aa56b3625770$import$910d596caca46c57;class x{constructor(e,t,i){this.card_=e,this.oldFaceUp_=t,this.newFaceUp_=i}undo(){this.card_.doSetFaceUp(this.oldFaceUp_)}redo(){this.card_.doSetFaceUp(this.newFaceUp_)}serialize(e){e.writeCard(this.card_),e.writeBool(this.oldFaceUp_),e.writeBool(this.newFaceUp_)}get deserializer(){return e=>x.deserialize(e)}static deserialize(e){let t=e.readCard(),i=e.readBool(),s=e.readBool();return new x(t,i,s)}}class y{get faceUp(){return this.faceUp_}set faceUp(e){if(this.faceUp_===e)return;let t=this.faceUp_,i=new x(this,t,e);this.game.addUndoableOperation(i),i.redo()}doSetFaceUp(e){this.faceUp_=e,this.faceUpChanged()}constructor(e,t,i,s,r,a){this.pileIndex=0,this.pileChanged=()=>{},this.pileIndexChanged=()=>{},this.faceUpChanged=()=>{},this.faceUp_=!1,this.game=e,this.suit=t,this.colour=i,this.rank=s,this.pile=r,this.pileIndex=a}onPileChanged(t,i){this.pile===t?this.onPileIndexChanged(i):(this.pile=t,this.pileIndex=i,e(this.pileIndex===this.pile.indexOf(this)),this.pileChanged())}onPileIndexChanged(t){this.pileIndex!==t&&(this.pileIndex=t,e(this.pileIndex===this.pile.indexOf(this)),this.pileIndexChanged())}serializeState(e){e.write(this.faceUp?1:0)}deserializeState(e){this.faceUp=0!==e.readRange(0,1)}}class k{add(e){let t=this.nextId_++;this.idToItem_.set(t,e),this.itemToId_.set(e,t)}get(e){let t=this.idToItem_.get(e);if(!t)throw Error(`Item with id ${e} not found.`);return t}getId(e){let t=this.itemToId_.get(e);if("number"!=typeof t)throw Error("Failed to find id for item.");return t}constructor(){this.nextId_=0,this.idToItem_=new Map,this.itemToId_=new Map}}class S{write(e){this.dataIndex_=this.data_.push(e)}writeBool(e){return this.write(e?1:0)}writeCard(e){this.write(this.getCardId(e))}writePile(e){this.write(this.getPileId(e))}writeUndoable(e){this.writeUndoableDeserializer_(e.deserializer),e.serialize(this)}writeUndoableDeserializer_(e){this.write(this.getUndoableDeserializerId(e))}read(){return this.data_[this.dataIndex_++]??t()}readRange(e,t){let i=this.read();if(i>=e&&i<=t)return i;throw Error(`Value ${i} not in range [${e}, ${t}].`)}readBool(){return 0!==this.readRange(0,1)}readCard(){return this.getCard(this.read())}readPile(){return this.getPile(this.read())}readUndoable(){let e=this.readUndoableDeserializer_();return e(this)}readUndoableDeserializer_(){return this.getUndoableDeserializer(this.read())}toJson(){return JSON.stringify(this.data_)}fromJson(e){let i=JSON.parse(e);(function(e){for(let i of(e instanceof Array||t("Value was not an array."),e))"number"!=typeof i&&t("Value was not a number.")})(i),this.data_=i,this.dataIndex_=0}ensureAtEnd(){if(this.dataIndex_!==this.data_.length)throw Error("Deserialization did not consume all data.")}addCard(e){return this.cardMap_.add(e)}getCard(e){return this.cardMap_.get(e)}getCardId(e){return this.cardMap_.getId(e)}addPile(e){return this.pileMap_.add(e)}getPile(e){return this.pileMap_.get(e)}getPileId(e){return this.pileMap_.getId(e)}addUndoableDeserializer(e){return this.undoableDeserializerMap_.add(e)}getUndoableDeserializer(e){return this.undoableDeserializerMap_.get(e)}getUndoableDeserializerId(e){return this.undoableDeserializerMap_.getId(e)}constructor(){this.data_=[],this.dataIndex_=0,this.cardMap_=new k,this.pileMap_=new k,this.undoableDeserializerMap_=new k}}class v{constructor(e,t,i,s,r){this.card_=e,this.oldPile_=t,this.oldPileIndex_=i,this.newPile_=s,this.newPileIndex_=r}undo(){this.oldPile_.doInsert(this.oldPileIndex_,this.card_)}redo(){this.newPile_.doInsert(this.newPileIndex_,this.card_)}serialize(e){e.writeCard(this.card_),e.writePile(this.oldPile_),e.write(this.oldPileIndex_),e.writePile(this.newPile_),e.write(this.newPileIndex_)}get deserializer(){return e=>v.deserialize(e)}static deserialize(e){let t=e.readCard(),i=e.readPile(),s=e.read(),r=e.readPile(),a=e.read();return new v(t,i,s,r,a)}}class D{constructor(e,t,i){this.pile_=e,this.oldMaxFan_=t,this.newMaxFan_=i}undo(){this.pile_.doSetMaxFan(this.oldMaxFan_)}redo(){this.pile_.doSetMaxFan(this.newMaxFan_)}serialize(e){e.writePile(this.pile_),e.write(this.oldMaxFan_),e.write(this.newMaxFan_)}get deserializer(){return e=>D.deserialize(e)}static deserialize(e){let t=e.readPile(),i=e.read(),s=e.read();return new D(t,i,s)}}class P{get length(){return this.cards_.length}get maxFan(){return this.maxFan_}set maxFan(e){if(e=Math.max(0,e),this.maxFan_===e)return;let t=this.maxFan_,i=new D(this,t,e);this.game.addUndoableOperation(i),i.redo()}doSetMaxFan(e){this.maxFan_=e,this.maxFanChanged()}constructor(e){this.cardsChanged=()=>{},this.maxFanChanged=()=>{},this.cards_=[],this.maxFan_=999,this.game=e}*[Symbol.iterator](){for(let e of this.cards_)yield e}createCard(e,t,i){let s=new y(this.game,e,t,i,this,this.length);return this.cards_.push(s),this.cardsChanged(),s}at(i){let s=this.cards_[i]??t();return e(s.pile===this),s}slice(e,t){return this.cards_.slice(e,t)}indexOf(e){return this.cards_.indexOf(e)}sort(){this.cards_.sort((e,t)=>e.suit<t.suit?-1:e.suit>t.suit?1:e.colour<t.colour?-1:e.colour>t.colour?1:e.rank<t.rank?-1:e.rank>t.rank?1:0);for(let e=0;e<this.cards_.length;++e){let i=this.cards_[e]??t();i.onPileIndexChanged(e)}this.cardsChanged()}shuffle(e){for(let i=0;i<this.cards_.length;++i){let s;[s,e]=m.uniformIntDistribution(i,this.cards_.length-1,e);let r=this.cards_[i]??t();this.cards_[i]=this.cards_[s]??t(),this.cards_[s]=r}for(let e=0;e<this.cards_.length;++e){let i=this.cards_[e]??t();i.onPileIndexChanged(e)}this.cardsChanged()}sortByRank(){this.cards_.sort((e,t)=>e.rank>t.rank?-1:e.rank<t.rank?1:e.colour<t.colour?-1:e.colour>t.colour?1:e.suit<t.suit?-1:e.suit>t.suit?1:0);for(let e=0;e<this.cards_.length;++e){let i=this.cards_[e]??t();i.onPileIndexChanged(e)}this.cardsChanged()}push(e){return this.insert(this.cards_.length,e)}peek(){if(!(this.cards_.length<=0))return this.at(this.cards_.length-1)}insert(e,t){let i=t.pile,s=t.pileIndex,r=new v(t,i,s,this,e);this.game.addUndoableOperation(r),r.redo()}doInsert(i,s){e(i>=0&&i<=this.cards_.length),s.pile===this&&i>s.pileIndex&&i--,s.pile.remove_(s),this.cards_.splice(i,0,s),s.onPileChanged(this,i);for(let e=i+1;e<this.cards_.length;++e){let i=this.cards_[e]??t();i.onPileIndexChanged(e)}return this.cardsChanged(),s}remove_(i){e(i.pile===this);let s=i.pileIndex;e(this.at(s)===i),this.cards_.splice(s,1);for(let e=s;e<this.cards_.length;++e){let i=this.cards_[e]??t();i.onPileIndexChanged(e)}return this.cardsChanged(),i}serializeState(e){for(let t of(e.write(this.maxFan),e.write(this.cards_.length),this.cards_))e.write(e.getCardId(t))}deserializeState(e){this.maxFan=e.readRange(0,999);let t=e.readRange(0,999);for(let i=0;i<t;++i){let t=e.getCard(e.read());this.insert(i,t)}}}class C{get length(){return this.ops_.length}addOperation(e){this.ops_.push(e)}undo(){for(let e=this.ops_.length;e-- >0;){let i=this.ops_[e]??t();i.undo()}}redo(){for(let e of this.ops_)e.redo()}serialize(e){for(let t of(e.write(this.ops_.length),this.ops_))e.writeUndoable(t)}get deserializer(){return e=>C.deserialize(e)}static deserialize(e){let t=new C,i=e.read();for(let s=0;s<i;++s)t.addOperation(e.readUndoable());return t}constructor(){this.ops_=[]}}class T{get gamesStarted(){return this.gamesStarted_}set gamesStarted(e){e!==this.gamesStarted_&&(this.gamesStarted_=e,this.gamesStartedChanged())}get gamesWon(){return this.gamesWon_}set gamesWon(e){e!==this.gamesWon_&&(this.gamesWon_=e,this.gamesWonChanged())}get canUndo(){return this.undoStack_.length>0}*undo(){let e=this.undoStack_.pop();e&&(e.undo(),this.redoStack_.push(e))}get canRedo(){return this.redoStack_.length>0}*redo(){let e=this.redoStack_.pop();e&&(e.redo(),this.undoStack_.push(e))}get won(){return this.won_}set won(e){e!==this.won_&&(this.won_=e,this.wonChanged())}checkWon_(){let e=this.won;this.won=this.doGetWon_(),!e&&this.won&&(this.undoStack_=[],this.redoStack_=[],++this.gamesWon)}*restart(e){if(this.startOperation_()){this.won=!1,++this.gamesStarted;let t=m.mersenne(e);yield*this.restart_(t),this.commitOperation_(),this.undoStack_=[],this.redoStack_=[],this.checkWon_()}}*pilePrimary(i){this.startOperation_()&&(i instanceof P||t(),e(this.piles.indexOf(i)>=0),yield*this.pilePrimary_(i),this.commitOperation_(),this.checkWon_())}*pileSecondary(i){this.startOperation_()&&(i instanceof P||t(),e(this.piles.indexOf(i)>=0),yield*this.pileSecondary_(i),this.commitOperation_(),this.checkWon_())}*cardPrimary(i){this.startOperation_()&&(i instanceof y||t(),e(this.cards.indexOf(i)>=0),yield*this.cardPrimary_(i),this.commitOperation_(),this.checkWon_())}*cardSecondary(i){this.startOperation_()&&(i instanceof y||t(),e(this.cards.indexOf(i)>=0),yield*this.cardSecondary_(i),this.commitOperation_(),this.checkWon_())}canDrag(i){return i instanceof y||t(),e(this.cards.indexOf(i)>=0),this.canDrag_(i)}previewDrop(i,s){return i instanceof y||t(),s instanceof P||t(),e(this.cards.indexOf(i)>=0),e(this.piles.indexOf(s)>=0),this.previewDrop_(i,s)}*dropCard(i,s){this.startOperation_()&&(i instanceof y||t(),s instanceof P||t(),e(this.cards.indexOf(i)>=0),e(this.piles.indexOf(s)>=0),yield*this.dropCard_(i,s),this.commitOperation_(),this.checkWon_())}startOperation_(){return!this.currentOperation_&&(this.currentOperation_=new C,!0)}addUndoableOperation(e){this.currentOperation_&&this.currentOperation_.addOperation(e)}commitOperation_(){this.currentOperation_||t(),this.currentOperation_.length>0&&(this.undoStack_.push(this.currentOperation_),this.redoStack_=[]),this.currentOperation_=void 0}serialize(){let e=this.createSerializationContext_();for(let t of(e.write(3),e.write(this.gamesStarted),e.write(this.gamesWon),this.cards))t.serializeState(e);for(let t of this.piles)t.serializeState(e);return this.serializeUndoStack_(e,this.undoStack_),this.serializeUndoStack_(e,this.redoStack_),e.toJson()}serializeUndoStack_(e,t){for(let i of(e.write(t.length),t))e.writeUndoable(i)}deserialize(e){try{this.won=!1;let t=this.createSerializationContext_();if(t.fromJson(e),3!==t.read())throw Error("Unknown save data format.");for(let e of(this.gamesStarted=t.read(),this.gamesWon=t.read(),this.cards))e.deserializeState(t);for(let e of this.piles)e.deserializeState(t);return this.undoStack_=this.deserializeUndoStack_(t),this.redoStack_=this.deserializeUndoStack_(t),t.ensureAtEnd(),this.won=this.doGetWon_(),!0}catch(e){return console.error("Failed to deserialize game state.",e),!1}}deserializeUndoStack_(e){let t=[],i=e.read();for(let s=0;s<i;++s)t.push(e.readUndoable());return t}createSerializationContext_(){let e=new S;for(let t of this.cards)e.addCard(t);for(let t of this.piles)e.addPile(t);return e.addUndoableDeserializer(e=>C.deserialize(e)),e.addUndoableDeserializer(e=>x.deserialize(e)),e.addUndoableDeserializer(e=>v.deserialize(e)),e.addUndoableDeserializer(e=>D.deserialize(e)),e}constructor(){this.cards=[],this.piles=[],this.undoStack_=[],this.redoStack_=[],this.currentOperation_=void 0,this.gamesStarted_=0,this.gamesStartedChanged=()=>{},this.gamesWon_=0,this.gamesWonChanged=()=>{},this.won_=!1,this.wonChanged=()=>{}}}class M extends T{constructor(e){super(),this.stock=new P(this),this.waste=new P(this),this.foundations=[],this.tableaux=[],this.dragSingleSources_=[],this.autoMoveSources_=[],this.restocks_=0,this.options=e,this.piles.push(this.stock),this.piles.push(this.waste),this.dragSingleSources_.push(this.waste),this.autoMoveSources_.push(this.waste);for(let e=0;e<4;++e){let e=new P(this);this.foundations.push(e),this.dragSingleSources_.push(e),this.piles.push(e)}for(let e=0;e<7;++e){let e=new P(this);this.tableaux.push(e),this.dragSingleSources_.push(e),this.autoMoveSources_.push(e),this.piles.push(e)}this.cards=n(this.stock)}doGetWon_(){let e=0;for(let t of this.foundations)e+=t.length;return 52===e}get wonCards(){let e=[];for(let t of this.foundations)for(let i of t)e.push(i);return e.sort((e,t)=>e.pileIndex>t.pileIndex?1:e.pileIndex<t.pileIndex?-1:e.rank>t.rank?1:e.rank<t.rank?-1:0),e}*restart_(e){for(let e of(this.restocks_=0,this.stock))e.faceUp=!1;for(let e=this.piles.length;e-- >0;){let i=this.piles[e]??t();if(i!==this.stock)for(let e=i.length;e-- >0;){let t=i.at(e);t.faceUp=!1,this.stock.push(t)}}this.stock.sort(),this.stock.shuffle(e),yield f.Settle;for(let e=0;e<this.tableaux.length;++e){let i=this.tableaux[e]??t();for(let t=0;t<=e;++t){let e=this.stock.peek();e&&(i.push(e),yield f.Quick)}}yield f.OneByOne,yield*this.doAutoMoves_()}*cardPrimary_(e){if(this.stock.peek()===e&&this.canDrawFromStock_()){yield*this.doDrawFromStock_(),yield*this.doAutoMoves_();return}if(this.tableaux.indexOf(e.pile)&&e.pile.peek()===e&&!e.faceUp){e.faceUp=!0,yield f.OneByOne,yield*this.doAutoMoves_();return}}*cardSecondary_(e){if(this.autoMoveSources_.indexOf(e.pile)>=0){for(let t of this.foundations)if(this.isFoundationDrop_(e,t)){t.push(e),yield f.OneByOne,yield*this.doAutoMoves_();return}}}*pilePrimary_(e){if(e===this.stock&&0===this.stock.length&&this.waste.length>0&&this.restocks_<this.options.restocksAllowed){this.restocks_++;for(let e=this.waste.length;e-- >0;){let t=this.waste.at(e);t.faceUp=!1}this.waste.maxFan=0,yield f.OneByOne;for(let e=this.waste.length;e-- >0;){let t=this.waste.at(e);this.stock.push(t)}yield f.OneByOne,yield*this.doAutoMoves_();return}}*pileSecondary_(e){}canDrag_(e){return this.isFoundationDropSource_(e)?{canDrag:!0,extraCards:[]}:this.isTableauxDropSource_(e)?{canDrag:!0,extraCards:e.pile.slice(e.pileIndex+1)}:{canDrag:!1,extraCards:[]}}previewDrop_(e,t){return this.isTableauxDrop_(e,t)||this.isFoundationDrop_(e,t)}*dropCard_(e,t){this.isTableauxDrop_(e,t)?(yield*this.doTableauxDrop_(e,t),yield*this.doAutoMoves_()):this.isFoundationDrop_(e,t)&&(yield*this.doFoundationDrop_(e,t),yield*this.doAutoMoves_())}canDrawFromStock_(){return this.stock.length>0}*doDrawFromStock_(){this.waste.maxFan=0;for(let e=0;e<this.options.stockDraws;++e){let t=this.stock.peek();t&&(this.waste.push(t),this.waste.maxFan++,yield f.Quick,t.faceUp=!0,e<this.options.stockDraws-1&&(yield f.Quick))}yield f.OneByOne}isTableauxDrop_(e,t){if(e.pile===t||!this.isTableauxDropSource_(e))return!1;if(this.tableaux.indexOf(t)>=0){let i=t.peek();if(i){if(this.getCardValue_(i)===this.getCardValue_(e)+1&&i.colour!==e.colour)return!0}else if(e.rank===_.King)return!0}return!1}isTableauxDropSource_(e){if(this.dragSingleSources_.indexOf(e.pile)>=0&&e.pile.peek()===e&&e.faceUp)return!0;if(this.tableaux.indexOf(e.pile)>=0&&e.pile.peek()?.faceUp)for(let t=e.pile.length-1;t-- >0;){let i=e.pile.at(t),s=e.pile.at(t+1);if(i.faceUp&&s.faceUp&&i.colour!==s.colour&&this.getCardValue_(s)===this.getCardValue_(i)-1){if(i===e)return!0}else break}return!1}*doTableauxDrop_(e,t){let i=e.pile,s=e.pile.slice(e.pileIndex);for(let e of s)t.push(e);i===this.waste&&this.waste.maxFan--,yield f.OneByOne}isFoundationDrop_(e,t){if(e.pile===t||!this.isFoundationDropSource_(e))return!1;if(this.foundations.indexOf(t)>=0){let i=t.peek();if(i){if(this.getCardValue_(i)+1===this.getCardValue_(e)&&i.suit===e.suit)return!0}else if(e.rank===_.Ace)return!0}return!1}isFoundationDropSource_(e){return this.dragSingleSources_.indexOf(e.pile)>=0&&e.pile.peek()===e&&e.faceUp}*doFoundationDrop_(e,t){let i=e.pile;t.push(e),i===this.waste&&this.waste.maxFan--,yield f.OneByOne}getCardValue_(e){switch(e.rank){case _.Ace:return 1;case _.Two:return 2;case _.Three:return 3;case _.Four:return 4;case _.Five:return 5;case _.Six:return 6;case _.Seven:return 7;case _.Eight:return 8;case _.Nine:return 9;case _.Ten:return 10;case _.Jack:return 11;case _.Queen:return 12;case _.King:return 13;default:t()}}*doAutoMoves_(){e:for(;;){if(this.options.autoReveal)for(let e of this.tableaux){let t=e.peek();if(t&&!t.faceUp){t.faceUp=!0,yield f.OneByOne;continue e}}if(this.options.autoMoveToFoundation>0){let e=999;for(let t of this.foundations){let i=t.peek();e=i?Math.min(e,this.getCardValue_(i)):Math.min(e,0)}for(let t of this.autoMoveSources_){let i=t.peek();if(i&&this.getCardValue_(i)<=e+this.options.autoMoveToFoundation){for(let e of this.foundations)if(this.isFoundationDrop_(i,e)){yield*this.doFoundationDrop_(i,e);continue e}}}}if(this.options.autoPlayStock&&0===this.waste.length&&this.canDrawFromStock_()){yield*this.doDrawFromStock_();continue e}break}}}function U(e){return e<=0?0:e>=1?1:e}class I{}function O(e,t,i){let s=e.get(t);if("string"!=typeof s||""===s)return i;let r=Number(s);return Number.isNaN(r)?i:r}function F(e,t,i,s){i!==s&&e.set(t,i.toString())}function b(e,t,i){let s=e.get(t);return"string"!=typeof s?i:""===s||!!s}function z(e,t,i,s){i!==s&&e.set(t,(i?1:0).toString())}class E extends I{get saveKey(){return{stockDraws:this.stockDraws,restocksAllowed:this.restocksAllowed}}constructor(e){var t;super(),this.stockDraws=1,this.restocksAllowed=1/0,this.autoReveal=!0,this.autoPlayStock=!0,this.autoMoveToFoundation=2,this.stockDraws=(t=O(e,"stockDraws",1))<=1?1:t>=5?5:t,this.restocksAllowed=O(e,"restocksAllowed",1/0),this.autoReveal=b(e,"autoReveal",!0),this.autoPlayStock=b(e,"autoPlayStock",!0),this.autoMoveToFoundation=Math.max(0,O(e,"autoMoveToFoundation",2))}toURLSearchParams(){let e=new URLSearchParams;return F(e,"stockDraws",this.stockDraws,1),F(e,"restocksAllowed",this.restocksAllowed,1/0),z(e,"autoReveal",this.autoReveal,!0),z(e,"autoPlayStock",this.autoPlayStock,!0),F(e,"autoMoveToFoundation",this.autoMoveToFoundation,2),e}}class V{constructor(e=0,t=0,i=0,s=0){this.sizeX=e,this.sizeY=t,this.x=i,this.y=s}get xMin(){return this.x-.5*this.sizeX}set xMin(e){let t=this.xMax;this.sizeX=t-e,this.x=.5*e+.5*t}get xMax(){return this.x+.5*this.sizeX}set xMax(e){let t=this.xMin;this.sizeX=e-t,this.x=.5*t+.5*e}get yMin(){return this.y-.5*this.sizeY}set yMin(e){let t=this.yMax;this.sizeX=t-e,this.y=.5*e+.5*t}get yMax(){return this.y+.5*this.sizeY}set yMax(e){let t=this.yMin;this.sizeX=e-t,this.y=.5*t+.5*e}set(e){return!this.equals(e)&&(this.x=e.x,this.y=e.y,this.sizeX=e.sizeX,this.sizeY=e.sizeY,!0)}setOnElement(e){e.style.left=`calc(50% + ${this.x-.5*this.sizeX}em)`,e.style.right=`calc(50% + ${-this.x-.5*this.sizeX}em)`,e.style.top=`calc(50% + ${this.y-.5*this.sizeY}em)`,e.style.bottom=`calc(50% + ${-this.y-.5*this.sizeY}em)`}equals(e){return this.x===e.x&&this.y===e.y&&this.sizeX===e.sizeX&&this.sizeY===e.sizeY}overlaps(e){let t=Math.min(this.xMax,e.xMax)-Math.max(this.xMin,e.xMin);if(t<=0)return 0;let i=Math.min(this.yMax,e.yMax)-Math.max(this.yMin,e.yMin);return i<=0?0:t*i}}class R{get rect(){let e=new V;return e.set(this.rect_),e}set rect(e){this.rect_.set(e)&&e.setOnElement(this.element)}get zIndex(){return this.zIndex_}set zIndex(e){this.zIndex_!==e&&(this.zIndex_=e,this.element.style.zIndex=`${e}`)}get faceUp(){return this.faceUp_}set faceUp(e){this.faceUp_!==e&&(this.faceUp_=e,e?this.element.classList.add("faceUp"):this.element.classList.remove("faceUp"))}get won(){return this.won_}set won(e){this.won_!==e&&(this.won_=e,e?this.element.classList.add("won"):this.element.classList.remove("won"))}get dropPreview(){return this.dropPreview_}set dropPreview(e){this.dropPreview_!==e&&(this.dropPreview_=e,e?this.element.classList.add("dropPreview"):this.element.classList.remove("dropPreview"))}constructor(e,t,i,r){this.click=()=>{},this.dblClick=()=>{},this.dragStart=()=>({canDrag:!1,extraCardViews:[]}),this.dragMoved=e=>{},this.dragEnd=(e,t)=>{},this.rect_=new V,this.zIndex_=0,this.faceUp_=!1,this.won_=!1,this.dropPreview_=!1,this.touchTracking_=!1,this.touchId_=0,this.touchInDeadZone_=!1,this.touchStartX_=0,this.touchStartY_=0,this.lastTouchEndTimeStamp_=0,this.dragging_=!1,this.dragExtraCardViews_=[],this.dragRect_=new V,this.onMouseDown_=e=>{0===e.button&&(e.preventDefault(),this.context.addTouchResponder(this),this.onTouchDown(-1,e.pageX,e.pageY,e.timeStamp))},this.touchStart_=e=>{for(let t=0;t<e.changedTouches.length;++t){let i=e.changedTouches.item(t);i&&(e.preventDefault(),this.context.addTouchResponder(this),this.onTouchDown(i.identifier,i.pageX,i.pageY,e.timeStamp))}},this.context=e.context,this.element=s(e.element,"cardViewTemplate"),this.element.classList.add(`s${t}c${i}r${r}`),this.element.addEventListener("mousedown",this.onMouseDown_),this.element.addEventListener("touchstart",this.touchStart_)}dispose(){this.element.removeEventListener("mousedown",this.onMouseDown_),this.element.removeEventListener("touchstart",this.touchStart_),this.element.remove()}onTouchDown(e,t,i,s){this.touchTracking_||(this.touchId_=e,this.touchTracking_=!0,this.touchInDeadZone_=!0,this.touchStartX_=t,this.touchStartY_=i,this.dragging_=!1)}onTouchMoved(e,t,s,r){if(this.touchTracking_&&this.touchId_===e){let e=t-this.touchStartX_,r=s-this.touchStartY_;if(this.touchInDeadZone_){let t=e*e+r*r;if(t>i.TOUCH_DEADZONE_SQ){let s=Math.sqrt(t);e/=s,r/=s,this.touchStartX_+=i.TOUCH_DEADZONE*e,this.touchStartY_+=i.TOUCH_DEADZONE*r,this.touchInDeadZone_=!1,this.startDragging_()}}if(this.dragging_){this.touchStartX_=t,this.touchStartY_=s;let i=this.context.pxPerRem;for(let t of(this.dragRect_.x+=i*e,this.dragRect_.y+=i*r,this.dragRect_.setOnElement(this.element),this.dragExtraCardViews_))t.dragRect_.x+=i*e,t.dragRect_.y+=i*r,t.dragRect_.setOnElement(t.element);this.dragMoved(this.dragRect_)}}}onTouchUp(e,t,i){this.touchTracking_&&this.touchId_===e&&(this.touchTracking_=!1,this.context.removeTouchResponder(this),this.touchInDeadZone_?(i<this.lastTouchEndTimeStamp_+1e3?this.dblClick():(this.lastTouchEndTimeStamp_=i,this.click()),this.stopDragging_(!0)):this.stopDragging_(!1))}startDragging_(){let{canDrag:e,extraCardViews:t}=this.dragStart();if(e)for(let e of(this.dragging_=!0,this.dragExtraCardViews_=t,this.dragRect_.set(this.rect_),this.element.classList.add("dragging"),this.dragExtraCardViews_))e.dragRect_.set(e.rect_),e.element.classList.add("dragging")}stopDragging_(e){if(this.dragging_){for(let e of(this.dragging_=!1,this.element.classList.remove("dragging"),this.rect_.setOnElement(this.element),this.dragExtraCardViews_))e.element.classList.remove("dragging"),e.rect_.setOnElement(e.element);this.dragEnd(this.dragRect_,e)}}}class A{get rect(){let e=new V;return e.set(this.rect_),e}set rect(e){this.rect_.set(e)&&e.setOnElement(this.element)}get hitbox(){let e=new V;return e.set(this.hitbox_),e}set hitbox(e){this.hitbox_.set(e)}get zIndex(){return this.zIndex_}set zIndex(e){this.zIndex_!==e&&(this.zIndex_=e,this.element.style.zIndex=`${e}`)}get showFrame(){return this.showFrame_}set showFrame(e){this.showFrame_!==e&&(this.showFrame_=e,e?this.element.classList.add("showFrame"):this.element.classList.remove("showFrame"))}get dropPreview(){return this.dropPreview_}set dropPreview(e){this.dropPreview_!==e&&(this.dropPreview_=e,e?this.element.classList.add("dropPreview"):this.element.classList.remove("dropPreview"))}constructor(e){this.click=()=>{},this.dblClick=()=>{},this.fanXDown=0,this.fanXUp=0,this.fanYDown=0,this.fanYUp=0,this.cardCount=0,this.rect_=new V,this.hitbox_=new V,this.zIndex_=0,this.showFrame_=!1,this.dropPreview_=!1,this.touchTracking_=!1,this.touchId_=0,this.touchInDeadZone_=!1,this.touchStartX_=0,this.touchStartY_=0,this.lastTouchEndTimeStamp_=0,this.onMouseDown_=e=>{0===e.button&&(e.preventDefault(),this.context.addTouchResponder(this),this.onTouchDown(-1,e.pageX,e.pageY,e.timeStamp))},this.touchStart_=e=>{for(let t=0;t<e.changedTouches.length;++t){let i=e.changedTouches.item(t);i&&(e.preventDefault(),this.context.addTouchResponder(this),this.onTouchDown(i.identifier,i.pageX,i.pageY,e.timeStamp))}},this.context=e.context,this.element=s(e.element,"pileViewTemplate"),this.element.addEventListener("mousedown",this.onMouseDown_),this.element.addEventListener("touchstart",this.touchStart_)}dispose(){this.element.removeEventListener("mousedown",this.onMouseDown_),this.element.removeEventListener("touchstart",this.touchStart_),this.element.remove()}onTouchDown(e,t,i,s){this.touchTracking_||(this.touchId_=e,this.touchTracking_=!0,this.touchInDeadZone_=!0,this.touchStartX_=t,this.touchStartY_=i)}onTouchMoved(e,t,s,r){if(this.touchTracking_&&this.touchId_===e){let e=t-this.touchStartX_,r=s-this.touchStartY_;if(this.touchInDeadZone_){let t=e*e+r*r;if(t>i.TOUCH_DEADZONE_SQ){let s=Math.sqrt(t);e/=s,r/=s,this.touchStartX_+=i.TOUCH_DEADZONE*e,this.touchStartY_+=i.TOUCH_DEADZONE*r,this.touchInDeadZone_=!1}}}}onTouchUp(e,t,i){this.touchTracking_&&this.touchId_===e&&(this.touchTracking_=!1,this.context.removeTouchResponder(this),this.touchInDeadZone_&&(i<this.lastTouchEndTimeStamp_+1e3?(this.dblClick(),this.lastTouchEndTimeStamp_=i):this.click()))}}class N{constructor(e,t){this.newGameButton_=document.getElementById("newGameButton"),this.undoButton_=document.getElementById("undoButton"),this.redoButton_=document.getElementById("redoButton"),this.pileViews_=[],this.pileToPileView_=new Map,this.pileViewtoPile_=new Map,this.cardViews_=[],this.cardToCardView_=new Map,this.cardViewtoCard_=new Map,this.dropPreview_=void 0,this.nextZIndex_=1e3,this.nextZIndexInc_=1,this.onNewGameButtonClick_=e=>{e.preventDefault(),this.restart_()},this.onUndoButtonClick_=e=>{e.preventDefault(),this.undo_()},this.onRedoButtonClick_=e=>{e.preventDefault(),this.redo_()},this.onWindowResize_=e=>{this.onResize_()},this.onWindowKeyDown_=e=>{"y"===e.key&&e.ctrlKey?(this.redo_(),e.stopPropagation(),e.preventDefault()):"z"===e.key&&e.ctrlKey?(this.undo_(),e.stopPropagation(),e.preventDefault()):"n"===e.key&&(this.restart_(),e.stopPropagation(),e.preventDefault())},this.operations_=[],this.game_=e,this.rootView_=t,e.wonChanged=()=>{this.gameWonChanged_()};let i=t.element.querySelector(".gameScore");i&&(e.gamesStartedChanged=e.gamesWonChanged=()=>{let t=e.won?e.gamesStarted:e.gamesStarted-1,s=t>0?(100*e.gamesWon/t).toFixed(2):"0";i.textContent=`${e.gamesWon} / ${t} - ${s}%`}),this.newGameButton_?.addEventListener("click",this.onNewGameButtonClick_),this.undoButton_?.addEventListener("click",this.onUndoButtonClick_),this.redoButton_?.addEventListener("click",this.onRedoButtonClick_),window.addEventListener("resize",this.onWindowResize_),window.addEventListener("keydown",this.onWindowKeyDown_)}dispose(){this.rootView_.dispose(),this.newGameButton_?.removeEventListener("click",this.onNewGameButtonClick_),this.undoButton_?.removeEventListener("click",this.onUndoButtonClick_),this.redoButton_?.removeEventListener("click",this.onRedoButtonClick_),window.removeEventListener("resize",this.onWindowResize_),window.removeEventListener("keydown",this.onWindowKeyDown_)}start(){let e=window.localStorage.getItem(this.saveDataKey_);e&&this.game_.deserialize(e)||this.restart_()}async gameWonChanged_(){if(this.game_.won){let e=0,i=this.game_.wonCards;for(let e of i){if(!this.game_.won)break;let t=this.getCardView_(e);t.zIndex=this.getNextZIndex_()}await this.waitForDelay_(f.Settle,e++);for(let s=i.length;s-- >0;){let r=i[s]??t();if(!this.game_.won)break;let a=this.getCardView_(r);a.won=!0;let o=a.rect;o.x=100*Math.random()-50,o.y=100*Math.random()-50,a.rect=o,await this.waitForDelay_(f.Settle,e++)}}else for(let e of this.cardViews_)e.won=!1}relayoutAll_(){for(let e of this.game_.piles){let t=this.getPileView_(e);this.relayoutPile_(t,e)}for(let e of this.game_.cards){let t=this.getCardView_(e);t.faceUp=e.faceUp}}createPileView_(e){let t=new A(this.rootView_);return this.pileViews_.push(t),this.pileToPileView_.set(e,t),this.pileViewtoPile_.set(t,e),e.cardsChanged=()=>this.onPileCardsChanged_(t,e),e.maxFanChanged=()=>this.onPileMaxFanChanged_(t,e),t.click=()=>this.pilePrimary_(e),t.dblClick=()=>this.pileSecondary_(e),t}getPile_(e){let i=this.pileViewtoPile_.get(e);return i||t(),i}getPileView_(e){let i=this.pileToPileView_.get(e);return i||t(),i}onPileCardsChanged_(e,t){this.relayoutPile_(e,t)}onPileMaxFanChanged_(e,t){this.relayoutPile_(e,t)}relayoutPile_(e,t){let i;e.cardCount=t.length;for(let e=t.length;e-- >0;){let s=t.at(e),r=this.getCardView_(s);i?r.zIndex=--i:i=r.zIndex}let s=t.length-t.maxFan,r=0,a=0,o=0,n=0;for(let i=0;i<t.length;++i){let h=t.at(i),l=this.getCardView_(h),d=e.rect;r=o,a=n,d.x+=o,d.y+=n,i>=s&&(h.faceUp?(o+=e.fanXUp,n+=e.fanYUp):(o+=e.fanXDown,n+=e.fanYDown)),l.rect=d}let h=e.rect;h.x+=.5*r,h.y+=.5*a,h.sizeX+=r,h.sizeY+=a,e.hitbox=h}createCardView_(e){let t=new R(this.rootView_,e.suit,e.colour,e.rank);return this.cardViews_.push(t),this.cardToCardView_.set(e,t),this.cardViewtoCard_.set(t,e),this.onCardPileChanged_(t,e),e.pileChanged=()=>this.onCardPileChanged_(t,e),this.onCardPileIndexChanged_(t,e),e.pileIndexChanged=()=>this.onCardPileIndexChanged_(t,e),this.onCardFaceUpChanged_(t,e),e.faceUpChanged=()=>this.onCardFaceUpChanged_(t,e),t.click=()=>this.cardPrimary_(e),t.dblClick=()=>this.cardSecondary_(e),t.dragStart=()=>this.cardDragStart_(t,e),t.dragMoved=i=>this.cardDragMoved_(t,e,i),t.dragEnd=(i,s)=>this.cardDragEnd_(t,e,i,s),t}getCard_(e){let i=this.cardViewtoCard_.get(e);return i||t(),i}getCardView_(e){let i=this.cardToCardView_.get(e);return i||t(),i}onCardPileChanged_(e,t){e.zIndex=this.getNextZIndex_()}onCardPileIndexChanged_(e,t){}onCardFaceUpChanged_(e,t){e.faceUp=t.faceUp}cardDragStart_(e,t){let{canDrag:i,extraCards:s}=this.game_.canDrag(t),r=this.getNextZIndex_();if(i){e.zIndex=r;for(let e=t.pileIndex+1;e<t.pile.length;++e){let i=t.pile.at(e),s=this.getCardView_(i);s.zIndex<r&&(s.zIndex=this.getNextZIndex_())}}let a=[];for(let e of s){let t=this.getCardView_(e);a.push(t),i&&t.zIndex<r&&(t.zIndex=this.getNextZIndex_())}return{canDrag:i,extraCardViews:a}}cardDragMoved_(e,t,i){let s=this.getBestDragPile_(t,i);if(s){let e=s.peek();if(e){let t=this.getCardView_(e);this.setDropPreview_(t);return}{let e=this.getPileView_(s);this.setDropPreview_(e);return}}this.setDropPreview_(void 0)}cardDragEnd_(e,t,i,s){if(!s){let e=this.getBestDragPile_(t,i);e&&this.doOperation_(()=>this.game_.dropCard(t,e))}this.setDropPreview_(void 0)}getBestDragPile_(e,t){let i;let s=0;for(let r of this.pileViews_){let a=this.getPile_(r),o=r.hitbox,n=t.overlaps(o);!(n<=0)&&(!i||s<n)&&this.game_.previewDrop(e,a)&&(i=a,s=n)}return i}setDropPreview_(e){e!==this.dropPreview_&&(this.dropPreview_&&(this.dropPreview_.dropPreview=!1),this.dropPreview_=e,this.dropPreview_&&(this.dropPreview_.dropPreview=!0))}getNextZIndex_(){let e=this.nextZIndex_;return this.nextZIndex_+=this.nextZIndexInc_,e}undo_(){this.doOperation_(()=>this.game_.undo())}redo_(){this.doOperation_(()=>this.game_.redo())}restart_(){this.doOperation_(()=>this.game_.restart(Date.now()))}pilePrimary_(e){this.doOperation_(()=>this.game_.pilePrimary(e))}pileSecondary_(e){this.doOperation_(()=>this.game_.pileSecondary(e))}cardPrimary_(e){this.doOperation_(()=>this.game_.cardPrimary(e))}cardSecondary_(e){this.doOperation_(()=>this.game_.cardSecondary(e))}async doOperation_(e){if(this.operations_.push(e),1===this.operations_.length)for(;this.operations_.length>0;){let e=0,i=this.operations_[0]??t();for(let t of i())this.operations_.length>1&&(e=Math.max(200,e)),await this.waitForDelay_(t,e++);this.operations_.shift();try{window.localStorage.setItem(this.saveDataKey_,this.game_.serialize())}catch{}}}async waitForDelay_(e,t){let i=Math.pow(.99,t);switch(e){case f.None:return;case f.Quick:await new Promise(e=>setTimeout(e,20*i));return;case f.OneByOne:await new Promise(e=>setTimeout(e,200*i));return;case f.Settle:await new Promise(e=>setTimeout(e,400*i));return}}}class B extends N{get saveDataKey_(){return JSON.stringify({gameName:"klondike",version:0,options:this.game_.options.saveKey})}constructor(e,i){super(e,i),this.foundationPiles_=[],this.tableauPiles_=[];{let t=this.createPileView_(e.stock);t.showFrame=!0,this.stockPile_=t}{let t=this.createPileView_(e.waste);t.showFrame=!0,t.zIndex=50,t.fanXUp=3,this.wastePile_=t}for(let i=0;i<this.game_.foundations.length;++i){let s=this.createPileView_(e.foundations[i]??t());s.showFrame=!0,s.zIndex=800,this.foundationPiles_.push(s)}for(let i=0;i<this.game_.tableaux.length;++i){let s=this.createPileView_(e.tableaux[i]??t());s.showFrame=!0,s.zIndex=800,this.tableauPiles_.push(s)}for(let t of e.cards)this.createCardView_(t);this.layoutPiles_(),this.relayoutAll_()}onResize_(){this.layoutPiles_(),this.relayoutAll_()}layoutPiles_(){let e=this.game_.tableaux.length,i=1;window.matchMedia("screen and (max-aspect-ratio: 100/130)").matches&&(i=1.5);let s=t=>(t-.5*(e-1))*13.85714285714745;{let e=this.game_.stock,t=this.getPileView_(e);t.rect=new V(12.85714285714745,20,s(0),-35*i+1)}{this.game_.waste;let e=this.getPileView_(this.game_.waste);e.rect=new V(12.85714285714745,20,s(1),-35*i+1)}for(let r=0;r<this.game_.foundations.length;++r){let a=this.game_.foundations[r]??t(),o=this.getPileView_(a);o.rect=new V(12.85714285714745,20,s(e-this.game_.foundations.length+r),-35*i+1)}for(let e=0;e<this.game_.tableaux.length;++e){let r=this.game_.tableaux[e]??t(),a=this.getPileView_(r);a.rect=new V(12.85714285714745,20,s(e),-35*i+1+1+20+1),a.fanYDown=3.5,a.fanYUp=3.5*i}}}class L{createGame(e,t){let i=new E(t),s=new M(i),a=new r(e);return new B(s,a)}}var W=new class{constructor(){this.gameId="klondike",this.gameName="Klondike",this.gamePresenterFactory=new L}};class K extends T{constructor(e){super(),this.stock=new P(this),this.foundations=[],this.tableaux=[],this.dragSingleSources_=[],this.dragAnySources_=[],this.autoMoveSources_=[],this.autoMoveAnySources_=[],this.restocks_=0,this.options=e,this.piles.push(this.stock),this.dragAnySources_.push(this.stock),this.autoMoveAnySources_.push(this.stock);for(let e=0;e<4;++e){let e=new P(this);this.foundations.push(e),this.dragSingleSources_.push(e),this.piles.push(e)}for(let e=0;e<7;++e){let e=new P(this);this.tableaux.push(e),this.dragSingleSources_.push(e),this.autoMoveSources_.push(e),this.piles.push(e)}this.cards=n(this.stock)}doGetWon_(){let e=0;for(let t of this.foundations)e+=t.length;return 52===e}get wonCards(){let e=[];for(let t of this.foundations)for(let i of t)e.push(i);return e.sort((e,t)=>e.pileIndex>t.pileIndex?1:e.pileIndex<t.pileIndex?-1:e.rank>t.rank?1:e.rank<t.rank?-1:0),e}*restart_(e){for(let e of(this.restocks_=0,this.stock.maxFan=0,this.stock))e.faceUp=!1;for(let e=this.piles.length;e-- >0;){let i=this.piles[e]??t();if(i!==this.stock)for(let e=i.length;e-- >0;){let t=i.at(e);t.faceUp=!1,this.stock.push(t)}}this.stock.sort(),this.stock.shuffle(e),yield f.Settle;for(let e=0;e<this.tableaux.length;++e){let i=this.tableaux[e]??t();for(let t=0;t<=e;++t){let e=this.stock.peek();e&&(i.push(e),yield f.Quick)}}this.stock.sortByRank();for(let e=this.stock.length;e-- >0;){let t=this.stock.at(e);t.faceUp=!0}this.stock.maxFan=999,yield f.OneByOne,yield*this.doAutoMoves_()}*cardPrimary_(e){if(this.tableaux.indexOf(e.pile)&&e.pile.peek()===e&&!e.faceUp){e.faceUp=!0,yield f.OneByOne,yield*this.doAutoMoves_();return}}*cardSecondary_(e){if(this.isFoundationDropSource_(e)){for(let t of this.foundations)if(this.isFoundationDrop_(e,t)){yield*this.doFoundationDrop_(e,t),yield*this.doAutoMoves_();return}}if(this.isTableauxDropSource_(e)){for(let t of this.tableaux)if(t!==e.pile&&this.isTableauxDrop_(e,t)){yield*this.doTableauxDrop_(e,t),yield*this.doAutoMoves_();return}}if(this.isTableauxSingleDropSource_(e)){for(let t of this.tableaux)if(t!==e.pile&&this.isTableauxSingleDrop_(e,t)){yield*this.doTableauxSingleDrop_(e,t),yield*this.doAutoMoves_();return}}}*pilePrimary_(e){}*pileSecondary_(e){}canDrag_(e){return this.isFoundationDropSource_(e)||this.isTableauxSingleDropSource_(e)?{canDrag:!0,extraCards:[]}:this.isTableauxDropSource_(e)?{canDrag:!0,extraCards:e.pile.slice(e.pileIndex+1)}:{canDrag:!1,extraCards:[]}}previewDrop_(e,t){return this.isTableauxDrop_(e,t)||this.isFoundationDrop_(e,t)||this.isTableauxSingleDrop_(e,t)}*dropCard_(e,t){this.isTableauxDrop_(e,t)?(yield*this.doTableauxDrop_(e,t),yield*this.doAutoMoves_()):this.isFoundationDrop_(e,t)?(yield*this.doFoundationDrop_(e,t),yield*this.doAutoMoves_()):this.isTableauxSingleDrop_(e,t)&&(yield*this.doTableauxSingleDrop_(e,t),yield*this.doAutoMoves_())}isTableauxDrop_(e,t){if(e.pile===t||!this.isTableauxDropSource_(e))return!1;if(this.tableaux.indexOf(t)>=0){let i=t.peek();if(i){if(this.getCardValue_(i)===this.getCardValue_(e)+1&&i.colour!==e.colour)return!0}else if(e.rank===_.King)return!0}return!1}isTableauxDropSource_(e){if(this.tableaux.indexOf(e.pile)>=0&&e.pile.peek()?.faceUp)for(let t=e.pile.length-1;t-- >0;){let i=e.pile.at(t),s=e.pile.at(t+1);if(i.faceUp&&s.faceUp&&i.colour!==s.colour&&this.getCardValue_(s)===this.getCardValue_(i)-1){if(i===e)return!0}else break}return!1}*doTableauxDrop_(e,t){e.pile;let i=e.pile.slice(e.pileIndex);for(let e of i)t.push(e);yield f.OneByOne}isTableauxSingleDrop_(e,t){if(e.pile===t||!this.isTableauxSingleDropSource_(e))return!1;if(this.tableaux.indexOf(t)>=0){let i=t.peek();if(i){if(this.getCardValue_(i)===this.getCardValue_(e)+1&&i.colour!==e.colour)return!0}else if(e.rank===_.King)return!0}return!1}isTableauxSingleDropSource_(e){return this.dragSingleSources_.indexOf(e.pile)>=0&&e.pile.peek()===e&&e.faceUp||this.dragAnySources_.indexOf(e.pile)>=0&&e.faceUp}*doTableauxSingleDrop_(e,t){t.push(e),yield f.OneByOne}isFoundationDrop_(e,t){if(e.pile===t||!this.isFoundationDropSource_(e))return!1;if(this.foundations.indexOf(t)>=0){let i=t.peek();if(i){if(this.getCardValue_(i)+1===this.getCardValue_(e)&&i.suit===e.suit)return!0}else if(e.rank===_.Ace)return!0}return!1}isFoundationDropSource_(e){return this.dragSingleSources_.indexOf(e.pile)>=0&&e.pile.peek()===e&&e.faceUp||this.dragAnySources_.indexOf(e.pile)>=0&&e.faceUp}*doFoundationDrop_(e,t){t.push(e),yield f.OneByOne}getCardValue_(e){switch(e.rank){case _.Ace:return 1;case _.Two:return 2;case _.Three:return 3;case _.Four:return 4;case _.Five:return 5;case _.Six:return 6;case _.Seven:return 7;case _.Eight:return 8;case _.Nine:return 9;case _.Ten:return 10;case _.Jack:return 11;case _.Queen:return 12;case _.King:return 13;default:t()}}*doAutoMoves_(){e:for(;;){if(this.options.autoReveal)for(let e of this.tableaux){let t=e.peek();if(t&&!t.faceUp){t.faceUp=!0,yield f.OneByOne;continue e}}if(this.options.autoMoveToFoundation>0){let e=999;for(let t of this.foundations){let i=t.peek();e=i?Math.min(e,this.getCardValue_(i)):Math.min(e,0)}for(let t of this.autoMoveSources_){let i=t.peek();if(i&&this.getCardValue_(i)<=e+this.options.autoMoveToFoundation){for(let e of this.foundations)if(this.isFoundationDrop_(i,e)){yield*this.doFoundationDrop_(i,e);continue e}}}for(let t of this.autoMoveAnySources_)for(let i=t.length;i-- >0;){let s=t.at(i);if(this.getCardValue_(s)<=e+this.options.autoMoveToFoundation){for(let e of this.foundations)if(this.isFoundationDrop_(s,e)){yield*this.doFoundationDrop_(s,e);continue e}}}}break}}}class Y extends I{get saveKey(){return{}}constructor(e){super(),this.autoReveal=!0,this.autoMoveToFoundation=2,this.autoReveal=b(e,"autoReveal",!0),this.autoMoveToFoundation=Math.max(0,O(e,"autoMoveToFoundation",2))}toURLSearchParams(){let e=new URLSearchParams;return z(e,"autoReveal",this.autoReveal,!0),F(e,"autoMoveToFoundation",this.autoMoveToFoundation,2),e}}class X extends N{get saveDataKey_(){return JSON.stringify({gameName:"klondike",version:0,options:this.game_.options.saveKey})}constructor(e,i){super(e,i),this.foundationPiles_=[],this.tableauPiles_=[];{let t=this.createPileView_(e.stock);t.showFrame=!0,t.fanYUp=3,t.fanYDown=3,this.stockPile_=t}for(let i=0;i<this.game_.foundations.length;++i){let s=this.createPileView_(e.foundations[i]??t());s.showFrame=!0,s.zIndex=800,this.foundationPiles_.push(s)}for(let i=0;i<this.game_.tableaux.length;++i){let s=this.createPileView_(e.tableaux[i]??t());s.showFrame=!0,s.zIndex=800,this.tableauPiles_.push(s)}for(let t of e.cards)this.createCardView_(t);this.layoutPiles_(),this.relayoutAll_()}onResize_(){this.layoutPiles_(),this.relayoutAll_()}layoutPiles_(){let e=this.rootView_.element.clientWidth/this.rootView_.element.clientHeight,i=this.game_.tableaux.length,s=20,r=0,a=1,o=1,n=!0;if(e<.77)a=1.5,n=!1;else if(r+=1,i+=1,e<1.12){var h;h=U(-((e-1.12)/.1200000000000001)),o=(s=20+-2.5*U(h))/20}let l=s/1.555555555555,d=e=>(e-.5*(i-1))*(l+1);{let t=this.game_.stock,i=this.getPileView_(t);n?(i.rect=new V(l,s,d(0),-35*a+1),i.fanXDown=0,i.fanXUp=0,i.fanYDown=3*o,i.fanYUp=3*o):(i.rect=new V(l,s,d(0),50/e-s),i.fanXDown=3.6*o,i.fanXUp=3.6*o,i.fanYDown=0,i.fanYUp=0)}for(let e=0;e<this.game_.foundations.length;++e){let r=this.game_.foundations[e]??t(),o=this.getPileView_(r);o.rect=new V(l,s,d(i-this.game_.foundations.length+e),-35*a+1)}for(let e=0;e<this.game_.tableaux.length;++e){let i=this.game_.tableaux[e]??t(),n=this.getPileView_(i);n.rect=new V(l,s,d(e+r),-35*a+1+1+s+1),n.fanYDown=3.5*o,n.fanYUp=o*a*3.5}}}class Z{createGame(e,t){let i=new Y(t),s=new K(i),a=new r(e);return new X(s,a)}}var $=new class{constructor(){this.gameId="klondikeex",this.gameName="Klondike Ex",this.gamePresenterFactory=new Z}};class J extends T{constructor(e){super(),this.stock=new P(this),this.waste=new P(this),this.foundation=new P(this),this.pyramid=[],this.pyramidCoords_=new Map,this.restocks_=0,this.options=e,this.piles.push(this.stock),this.piles.push(this.waste),this.piles.push(this.foundation);for(let e=0;e<7;++e){let t=[];this.pyramid.push(t);for(let i=0;i<=e;++i){let s=new P(this);t.push(s),this.pyramidCoords_.set(s,{x:i,y:e}),this.piles.push(s)}}this.cards=n(this.stock)}doGetWon_(){let e=0;for(let t of this.pyramid)for(let i of t)e+=i.length;return 0===e}get wonCards(){let e=[];for(let t of this.foundation)e.push(t);return e.sort((e,t)=>e.pileIndex-t.pileIndex),e}*restart_(e){for(let e of(this.restocks_=0,this.stock))e.faceUp=!1;for(let e=this.piles.length;e-- >0;){let i=this.piles[e]??t();if(i!==this.stock)for(let e=i.length;e-- >0;){let t=i.at(e);t.faceUp=!1,this.stock.push(t)}}for(let t of(this.stock.sort(),this.stock.shuffle(e),yield f.Settle,this.pyramid))for(let e of t){let t=this.stock.peek();t&&(e.push(t),t.faceUp=!0,yield f.Quick)}yield*this.doAutoMoves_()}*cardPrimary_(e){if(e.rank===_.King&&this.isFree_(e)){this.foundation.push(e),yield*this.doAutoMoves_();return}if(this.stock.peek()===e){e.faceUp?this.waste.push(e):e.faceUp=!0,yield*this.doAutoMoves_();return}}*cardSecondary_(e){}*pilePrimary_(e){if(e===this.stock&&0===this.stock.length&&this.waste.length>0&&this.restocks_<this.options.restocksAllowed){this.restocks_++;for(let e=this.waste.length;e-- >0;){let t=this.waste.at(e);t.faceUp=!1}yield f.OneByOne;for(let e=this.waste.length;e-- >0;){let t=this.waste.at(e);this.stock.push(t)}yield*this.doAutoMoves_();return}}*pileSecondary_(e){}canDrag_(e){return{canDrag:this.isFree_(e),extraCards:[]}}previewDrop_(e,t){return this.is13Move_(e,t)}*dropCard_(e,i){this.is13Move_(e,i)&&(this.foundation.push(i.peek()??t()),this.foundation.push(e),yield*this.doAutoMoves_())}isFree_(e){if(!e.faceUp)return!1;if(this.stock.peek()===e||this.waste.peek()===e)return!0;let i=this.pyramidCoords_.get(e.pile);if(i){let e=this.pyramid[i.y+1];if(!e)return!0;let s=e[i.x]??t(),r=e[i.x+1]??t();return 0===s.length&&0===r.length}return!1}is13Move_(e,t){if(e.pile===t||!this.isFree_(e))return!1;let i=t.peek();return!!(i&&this.isFree_(i))&&this.getCardValue_(e)+this.getCardValue_(i)===13}getCardValue_(e){switch(e.rank){case _.Ace:return 1;case _.Two:return 2;case _.Three:return 3;case _.Four:return 4;case _.Five:return 5;case _.Six:return 6;case _.Seven:return 7;case _.Eight:return 8;case _.Nine:return 9;case _.Ten:return 10;case _.Jack:return 11;case _.Queen:return 12;case _.King:return 13;default:return 0}}*doAutoMoves_(){e:for(;;){if(this.options.autoPlayKings){{let e=this.stock.peek();if(e&&this.isFree_(e)&&13===this.getCardValue_(e)){yield f.OneByOne,this.foundation.push(e);continue e}}{let e=this.waste.peek();if(e&&this.isFree_(e)&&13===this.getCardValue_(e)){yield f.OneByOne,this.foundation.push(e);continue e}}for(let e of this.pyramid)for(let t of e){let e=t.peek();if(e&&this.isFree_(e)&&13===this.getCardValue_(e)){yield f.OneByOne,this.foundation.push(e);continue e}}}if(this.options.autoRevealStockTop){let e=this.stock.peek();if(e&&!e.faceUp){yield f.OneByOne,e.faceUp=!0;continue e}}break}}}class Q extends I{get saveKey(){return{restocksAllowed:this.restocksAllowed}}constructor(e){super(),this.restocksAllowed=2,this.autoRevealStockTop=!0,this.autoPlayKings=!0,this.restocksAllowed=O(e,"restocksAllowed",1/0),this.autoRevealStockTop=b(e,"autoRevealStockTop",!0),this.autoPlayKings=b(e,"autoPlayKings",!0)}toURLSearchParams(){let e=new URLSearchParams;return F(e,"restocksAllowed",this.restocksAllowed,1/0),z(e,"autoRevealStockTop",this.autoRevealStockTop,!0),z(e,"autoPlayKings",this.autoPlayKings,!0),e}}class G extends N{get saveDataKey_(){return JSON.stringify({gameName:"pyramid",version:0,options:this.game_.options.saveKey})}constructor(e,i){super(e,i),this.pyramidPiles_=[];{let t=this.createPileView_(e.stock);t.showFrame=!0,this.stockPile_=t}{let t=this.createPileView_(e.waste);t.showFrame=!0,t.zIndex=50,this.wastePile_=t}{let t=this.createPileView_(e.foundation);t.showFrame=!0,t.zIndex=800,this.foundationPile_=t}for(let i=0;i<e.pyramid.length;++i){let s=e.pyramid[i]??t(),r=[];for(let e of s){let t=this.createPileView_(e);t.zIndex=100*i,r.push(t)}this.pyramidPiles_.push(r)}for(let t of e.cards)this.createCardView_(t);this.layoutPiles_(),this.relayoutAll_()}onResize_(){this.layoutPiles_(),this.relayoutAll_()}layoutPiles_(){let e=this.game_.pyramid.length,i=(e,t)=>(e-.5*(t-1))*14.35714285714745,s=t=>(t-.5*(e-1))*13;{let t=this.stockPile_;t.rect=new V(12.85714285714745,20,i(0,e),s(0))}{let t=this.wastePile_;t.rect=new V(12.85714285714745,20,i(1,e),s(0))}{let t=this.foundationPile_;t.rect=new V(12.85714285714745,20,i(e-1,e),s(0))}for(let r=0;r<e;++r){let e=this.game_.pyramid[r]??t();for(let a=0;a<e.length;++a){let o=this.pyramidPiles_[r]??t(),n=o[a]??t();n.rect=new V(12.85714285714745,20,i(a,e.length),s(r))}}}}class H{createGame(e,t){let i=new Q(t),s=new J(i),a=new r(e);return new G(s,a)}}var q=new class{constructor(){this.gameId="pyramid",this.gameName="Pyramid",this.gamePresenterFactory=new H}};let j=new Map;j.set(W.gameId,W),j.set($.gameId,$),j.set(q.gameId,q),window.addEventListener("load",()=>{let e;let i=document.getElementById("tableHolder")??document.body,s=()=>{let s,r;e&&(e.dispose(),e=void 0);let a=window.location.hash,o=a.indexOf("?");o>=0?(s=new URLSearchParams(a.substr(o+1)),r=a.substr(1,o-1)):a.includes("&")||a.includes("?")||a.includes("=")?r=(s=new URLSearchParams(a.substr(1))).get("game"):(s=new URLSearchParams(""),r=a.substr(1)),r||(r=W.gameId);let n=j.get(r.toLowerCase());n||t(`Unknown game ${r}.`),(e=n.gamePresenterFactory.createGame(i,s)).start()};window.addEventListener("hashchange",s),s()})}();